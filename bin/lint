#!/usr/bin/env ruby
# frozen_string_literal: true

# == Helpers
def system!(*args, dir: nil)
  system(*args) || abort("Command `#{args.join(' ')}' failed")
end

def scoped(&block) = yield

# == Dependencies
system("bundle", "install", "--quiet") ||
  abort("Failed to install Ruby dependencies")
system("npm", "install") || abort("Failed to install Node dependencies")

# == Options
require "optparse"

options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: bin/lint [--fix] <targets...>"
  opts.on("--fix", "Auto-fix code offences without correcting them") do |fix|
    options[:fix] = fix
  end
  opts.on("--ci", "Output in CI-friendly format") do |ci|
    options[:ci] = ci
  end
end.parse!

# == Formatting
puts "=> Running RuboCop"
scoped do
  args = []
  args << "--autocorrect" if options[:fix]
  args << "-f" << "github" if options[:ci]
  system!(
    "bin/rubocop",
    "--except",
    "Layout,Lint/RedundantCopDisableDirective",
    *args,
  )
end

puts "\n=> Running Typescript compiler"
system! "npx", "tsc"
puts "No errors found"

puts "\n=> Running ESLint"
scoped do
  args = %w[--ext .js,.jsx,.ts,.tsx]
  args << "--fix" if options[:fix]
  args << "."
  system!("npx", "eslint", "--report-unused-disable-directives", *args)
  puts "No problems or warnings"
end

puts "\n=> Running Sorbet"
system! "bin/srb", "typecheck"

puts "\n=> Running Mypy"
system! "bin/mypy", "."
